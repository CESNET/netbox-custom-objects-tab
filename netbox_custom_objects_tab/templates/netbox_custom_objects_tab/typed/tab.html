{% extends base_template %}
{% load helpers %}
{% load buttons %}
{% load render_table from django_tables2 %}
{% load i18n %}

{% block content %}

  {% if table %}
    <hr class="mt-0 mb-3">
    {# Results / Filters inner tabs #}
    <ul class="nav nav-tabs custom-objects-subtabs mb-3" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="object-list-tab" data-bs-toggle="tab" data-bs-target="#object-list" type="button" role="tab" aria-controls="object-list" aria-selected="true">
          {% trans "Results" %}
          <span class="badge text-bg-secondary total-object-count">{{ table.page.paginator.count }}</span>
        </a>
      </li>
      {% if filter_form %}
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="filters-form-tab" data-bs-toggle="tab" data-bs-target="#filters-form" type="button" role="tab" aria-controls="filters-form" aria-selected="false">
            {% trans "Filters" %}
            {% if filter_form %}{% badge filter_form.changed_data|length bg_color="primary" %}{% endif %}
          </button>
        </li>
      {% endif %}
    </ul>

    {# Results tab pane #}
    <div class="tab-pane show active" id="object-list" role="tabpanel" aria-labelledby="object-list-tab">

      {# Applied filters #}
      {% if filter_form %}
        {% applied_filters model filter_form request.GET %}
      {% endif %}

      {# Table controls: quick search + configure table #}
      {% include 'inc/table_controls_htmx.html' with table_modal=table.name|add:"_config" %}

      <form method="post" class="form form-horizontal"
            action="{% url 'plugins:netbox_custom_objects:customobject_bulk_delete' custom_object_type=custom_object_type.slug %}">
        {% csrf_token %}

        {# Select all (multi-page) #}
        {% if table.paginator.num_pages > 1 %}
          <div id="select-all-box" class="d-none card d-print-none">
            <div class="form col-md-12">
              <div class="card-body d-flex justify-content-between">
                <div class="form-check">
                  <input type="checkbox" id="select-all" name="_all" class="form-check-input" />
                  <label for="select-all" class="form-check-label">
                    {% blocktrans trimmed with count=table.page.paginator.count %}
                      Select <strong>all <span class="total-object-count">{{ count }}</span></strong> matching query
                    {% endblocktrans %}
                  </label>
                </div>
                <div class="bulk-action-buttons">
                  <button type="submit" name="_edit" formaction="{% url 'plugins:netbox_custom_objects:customobject_bulk_edit' custom_object_type=custom_object_type.slug %}?return_url={{ return_url|urlencode:'' }}" class="btn btn-yellow">
                    <i class="mdi mdi-pencil" aria-hidden="true"></i> Bulk Edit
                  </button>
                  <button type="submit" name="_delete" formaction="{% url 'plugins:netbox_custom_objects:customobject_bulk_delete' custom_object_type=custom_object_type.slug %}?return_url={{ return_url|urlencode:'' }}" class="btn btn-red">
                    <i class="mdi mdi-trash-can-outline" aria-hidden="true"></i> Bulk Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        <div class="form form-horizontal">
          {% csrf_token %}
          <input type="hidden" name="return_url" value="{{ return_url }}" />

          {# Objects table #}
          <div class="card">
            <div class="htmx-container table-responsive" id="object_list">
              {% include 'htmx/table.html' %}
            </div>
          </div>

          {# Bulk action buttons #}
          <div class="btn-list d-print-none">
            <div class="bulk-action-buttons">
              <button type="submit" name="_edit" formaction="{% url 'plugins:netbox_custom_objects:customobject_bulk_edit' custom_object_type=custom_object_type.slug %}?return_url={{ return_url|urlencode:'' }}" class="btn btn-yellow">
                <i class="mdi mdi-pencil" aria-hidden="true"></i> Bulk Edit
              </button>
              <button type="submit" name="_delete" formaction="{% url 'plugins:netbox_custom_objects:customobject_bulk_delete' custom_object_type=custom_object_type.slug %}?return_url={{ return_url|urlencode:'' }}" class="btn btn-red">
                <i class="mdi mdi-trash-can-outline" aria-hidden="true"></i> Bulk Delete
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    {# Filters tab pane #}
    {% if filter_form %}
      <div class="tab-pane show" id="filters-form" role="tabpanel" aria-labelledby="filters-form-tab">
        {% include 'inc/filter_list.html' %}
      </div>
    {% endif %}

  {% else %}
    <div class="card">
      <div class="card-body text-muted">
        {% trans "No custom objects are linked to this object." %}
      </div>
    </div>
  {% endif %}

{% endblock content %}

{% block modals %}
  {% if table %}
    {% table_config_form table %}
  {% endif %}
{% endblock modals %}
